# RenToken 合约测试案例文档

## 项目概述

本文档基于 RenToken 项目的智能合约代码和项目提示词，提供全面的测试案例，涵盖房地产代币化平台的各种场景。

## 合约架构

- **SeriesFactory**: 主平台合约，管理 RTN 代币系列的创建和利润分发
- **RentToken**: ERC20 代币合约，代表房地产未来租金收入
- **PropertyOracle**: 房产信息预言机合约
- **KYCOracle**: KYC 验证预言机（接口）
- **SanctionOracle**: 制裁检查预言机（接口）

## 测试案例分类

### 1. 合约部署和初始化测试

#### 1.1 正常部署场景
- **测试用例**: 部署 SeriesFactory 合约
  - **前置条件**: 有效的 PropertyOracle 地址
  - **执行步骤**: 使用正确参数部署合约
  - **预期结果**: 合约成功部署，角色正确分配

#### 1.2 异常部署场景
- **测试用例**: 使用零地址部署 SeriesFactory
  - **前置条件**: PropertyOracle 地址为 0x0
  - **执行步骤**: 尝试部署合约
  - **预期结果**: 部署失败或后续调用失败

### 2. 房产信息管理测试（PropertyOracle）

#### 2.1 房产添加场景
- **测试用例**: 添加标准房产信息
  - **房产信息**:
    - propertyId: 1001
    - payoutToken: USDC (0x...)
    - valuation: 1,000,000 USDC
    - minRaising: 100,000 USDC
    - maxRaising: 800,000 USDC
    - accrualStart: 2024-01-01
    - accrualEnd: 2026-12-31
    - landlord: 0x...
    - city: "Amsterdam"
  - **预期结果**: 房产信息成功添加，版本号为 1

#### 2.2 房产信息更新场景
- **测试用例**: 更新现有房产估值
  - **执行步骤**: 修改房产估值从 1,000,000 到 1,200,000
  - **预期结果**: 房产信息更新成功，版本号递增

#### 2.3 异常房产信息场景
- **测试用例**: 添加无效时间范围的房产
  - **房产信息**: accrualStart > accrualEnd
  - **预期结果**: 交易回滚，抛出 "Invalid time range" 错误

- **测试用例**: 添加无效募集范围的房产
  - **房产信息**: minRaising > maxRaising
  - **预期结果**: 交易回滚，抛出 "Invalid raising range" 错误

### 3. 代币系列创建测试（SeriesFactory）

#### 3.1 正常创建场景
- **测试用例**: 为阿姆斯特丹房产创建代币系列
  - **参数**:
    - propertyId: 1001
    - name: "RenToken Amsterdam 001"
    - symbol: "RTAMS1"
  - **预期结果**: 成功创建代币合约，映射关系建立

#### 3.2 重复创建场景
- **测试用例**: 为同一房产重复创建代币系列
  - **执行步骤**: 对已存在系列的房产再次调用 createSeries
  - **预期结果**: 交易回滚，抛出 "Series already exists" 错误

#### 3.3 不存在房产场景
- **测试用例**: 为不存在的房产创建代币系列
  - **参数**: propertyId: 9999（不存在）
  - **预期结果**: 交易回滚，抛出 "Property not found" 错误

### 4. 募资阶段测试（RentToken - Fundraising Phase）

#### 4.1 正常投资场景
- **测试用例**: 用户正常投资
  - **前置条件**: 
    - 用户通过 KYC 验证
    - 用户未被制裁
    - 合约处于募资阶段
  - **投资金额**: 50,000 USDC
  - **预期结果**: 
    - 用户获得相应代币
    - totalFundRaised 增加
    - 触发 ContributionReceived 事件

#### 4.2 大额投资场景
- **测试用例**: 单笔投资达到最大募集额
  - **投资金额**: 800,000 USDC（等于 maxRaising）
  - **预期结果**: 
    - 投资成功
    - 合约状态可能转为 AccrualStarted

#### 4.3 超额投资场景
- **测试用例**: 投资金额超过剩余可募集额度
  - **前置条件**: 已募集 750,000 USDC
  - **投资金额**: 100,000 USDC
  - **预期结果**: 根据实现，可能拒绝或只接受部分金额

#### 4.4 KYC 失败场景
- **测试用例**: 未通过 KYC 的用户尝试投资
  - **前置条件**: 用户未在 KYC 白名单中
  - **预期结果**: 交易回滚，抛出 "Sender not KYC verified" 错误

#### 4.5 制裁用户场景
- **测试用例**: 被制裁用户尝试投资
  - **前置条件**: 用户在制裁名单中
  - **预期结果**: 交易回滚，抛出 "Sender is sanctioned" 错误

### 5. 募资失败场景测试（RisingFailed Phase）

#### 5.1 募资期结束未达最小额度
- **测试用例**: 募资期结束时总额低于 minRaising
  - **前置条件**: 
    - 募资期已结束
    - totalFundRaised < minRaising (例如：80,000 < 100,000)
  - **预期结果**: 合约状态变为 RisingFailed

#### 5.2 退款场景
- **测试用例**: 募资失败后用户申请退款
  - **前置条件**: 合约处于 RisingFailed 状态
  - **用户投资**: 30,000 USDC
  - **预期结果**: 
    - 用户获得全额退款
    - 代币被销毁
    - 触发 RefundProcessed 事件

#### 5.3 批量退款场景
- **测试用例**: 多个用户同时申请退款
  - **前置条件**: 10 个用户各投资不同金额
  - **预期结果**: 所有用户都能获得相应退款

### 6. 运营阶段测试（AccrualStarted Phase）

#### 6.1 正常利润分发场景
- **测试用例**: 平台接收并分发租金收益
  - **前置条件**: 合约处于 AccrualStarted 状态
  - **利润金额**: 5,000 USDC（月租金）
  - **预期结果**: 
    - accumulatedRewardPerToken 更新
    - 触发 ProfitReceived 事件

#### 6.2 多次利润分发场景
- **测试用例**: 连续 12 个月的租金分发
  - **每月利润**: 5,000 USDC
  - **预期结果**: 
    - accumulatedRewardPerToken 累积增长
    - 用户可提取收益持续增加

#### 6.3 用户提取收益场景
- **测试用例**: 用户提取累积的租金收益
  - **前置条件**: 
    - 用户持有 10,000 代币
    - 已分发 3 个月利润
  - **预期结果**: 
    - 用户获得相应比例的收益
    - debt 和 claimable 正确更新

#### 6.4 代币转移场景
- **测试用例**: 用户之间转移代币
  - **前置条件**: 双方都通过 KYC 且未被制裁
  - **转移金额**: 5,000 代币
  - **预期结果**: 
    - 转移成功
    - 收益权正确转移

#### 6.5 代币转移限制场景
- **测试用例**: 向未 KYC 用户转移代币
  - **前置条件**: 接收方未通过 KYC
  - **预期结果**: 交易回滚，抛出 "Recipient not KYC verified" 错误

### 7. 合约到期测试（AccrualFinished Phase）

#### 7.1 正常到期场景
- **测试用例**: 合约到达 accrualEnd 时间
  - **前置条件**: 当前时间 >= accrualEnd
  - **预期结果**: 合约状态变为 AccrualFinished

#### 7.2 最终收益分发场景
- **测试用例**: 合约到期后的最后一次收益分发
  - **利润金额**: 10,000 USDC（包含押金退还）
  - **预期结果**: 所有用户都能提取最终收益

### 8. 紧急情况测试（Terminated Phase）

#### 8.1 合约暂停场景
- **测试用例**: 管理员暂停合约操作
  - **执行步骤**: 调用 pause() 函数
  - **预期结果**: 
    - 大部分操作被禁用
    - 只有紧急操作可执行

#### 8.2 合约终止场景
- **测试用例**: 因不可抗力终止合约
  - **前置条件**: 房产被意外损毁
  - **预期结果**: 
    - 合约状态变为 Terminated
    - 启动紧急退款流程

### 9. 权限管理测试

#### 9.1 角色权限测试
- **测试用例**: 不同角色执行相应操作
  - **ADMIN_ROLE**: 创建代币系列
  - **OPERATOR_ROLE**: 分发利润
  - **普通用户**: 投资和提取收益
  - **预期结果**: 权限控制正确执行

#### 9.2 权限越权测试
- **测试用例**: 普通用户尝试执行管理员操作
  - **执行步骤**: 普通用户调用 createSeries
  - **预期结果**: 交易回滚，抛出权限错误

### 10. 边界条件测试

#### 10.1 零金额操作
- **测试用例**: 投资 0 USDC
  - **预期结果**: 交易回滚或被忽略

#### 10.2 最大值测试
- **测试用例**: 投资 uint256 最大值
  - **预期结果**: 根据实现处理溢出情况

#### 10.3 时间边界测试
- **测试用例**: 在 accrualStart 的前一秒和后一秒执行操作
  - **预期结果**: 状态转换正确触发

### 11. 复杂业务场景测试

#### 11.1 多房产组合场景
- **测试用例**: 同时管理 10 个不同房产的代币系列
  - **房产类型**: 住宅、商业、工业混合
  - **地理分布**: 阿姆斯特丹、柏林、巴黎
  - **预期结果**: 各系列独立运行，互不影响

#### 11.2 大规模用户场景
- **测试用例**: 1000 个用户同时参与投资
  - **投资分布**: 从 100 USDC 到 50,000 USDC 不等
  - **预期结果**: 系统稳定运行，gas 费用合理

#### 11.3 长期运营场景
- **测试用例**: 模拟 3 年完整运营周期
  - **包含事件**: 
    - 36 次月度利润分发
    - 多次用户进出
    - 代币转移交易
    - 收益提取操作
  - **预期结果**: 所有财务计算准确无误

### 12. 异常恢复测试

#### 12.1 Oracle 故障场景
- **测试用例**: PropertyOracle 临时不可用
  - **故障模拟**: Oracle 返回错误数据
  - **预期结果**: 合约能够优雅处理或暂停相关操作

#### 12.2 代币合约升级场景
- **测试用例**: RentToken 合约需要升级
  - **前置条件**: 发现合约漏洞需要修复
  - **预期结果**: 使用 UUPS 代理模式成功升级

#### 12.3 网络拥堵场景
- **测试用例**: 以太坊网络极度拥堵
  - **模拟条件**: Gas 价格超过 1000 Gwei
  - **预期结果**: 合约仍能正常运行，用户可选择等待

### 13. 安全性测试

#### 13.1 重入攻击测试
- **测试用例**: 恶意合约尝试重入攻击
  - **攻击目标**: receiveProfit 和 claimReward 函数
  - **预期结果**: ReentrancyGuard 成功防护

#### 13.2 整数溢出测试
- **测试用例**: 尝试触发整数溢出
  - **攻击方式**: 极大数值的计算操作
  - **预期结果**: Solidity 0.8+ 内置保护生效

#### 13.3 前端运行攻击测试
- **测试用例**: 攻击者尝试抢先交易
  - **场景**: 在大额利润分发前抢先购买代币
  - **预期结果**: 通过合理的时间锁或其他机制防护

### 14. 合规性测试

#### 14.1 KYC 合规场景
- **测试用例**: 模拟真实 KYC 流程
  - **用户类型**: 个人投资者、机构投资者
  - **验证要求**: 身份证明、资金来源证明
  - **预期结果**: 只有通过验证的用户能参与

#### 14.2 制裁合规场景
- **测试用例**: 实时制裁名单检查
  - **检查频率**: 每次交易前检查
  - **名单更新**: 制裁名单实时更新
  - **预期结果**: 被制裁地址立即被阻止

#### 14.3 税务合规场景
- **测试用例**: 收益分发的税务处理
  - **收益类型**: 租金收入、资本增值
  - **税务要求**: 不同司法管辖区的要求
  - **预期结果**: 提供必要的税务报告数据

### 15. 性能测试

#### 15.1 Gas 优化测试
- **测试用例**: 各操作的 Gas 消耗分析
  - **操作类型**: 投资、提取、转移、分发
  - **优化目标**: 每个操作 < 200,000 Gas
  - **预期结果**: Gas 消耗在合理范围内

#### 15.2 批量操作测试
- **测试用例**: 批量处理多个用户操作
  - **批量大小**: 100 个用户同时操作
  - **预期结果**: 单个区块能处理完成

### 16. 用户体验测试

#### 16.1 移动端兼容性
- **测试用例**: 移动钱包交互测试
  - **钱包类型**: MetaMask Mobile, Trust Wallet
  - **预期结果**: 交互流畅，签名正确

#### 16.2 错误信息友好性
- **测试用例**: 各种错误情况的用户提示
  - **错误类型**: 权限不足、余额不足、时间限制
  - **预期结果**: 错误信息清晰易懂

## 测试数据准备

### 测试账户
- **管理员账户**: 0x1111... (拥有所有权限)
- **操作员账户**: 0x2222... (拥有 OPERATOR_ROLE)
- **房东账户**: 0x3333... (房产所有者)
- **投资者账户**: 0x4444..., 0x5555..., 0x6666... (通过 KYC)
- **受限账户**: 0x7777... (未通过 KYC), 0x8888... (被制裁)

### 测试代币
- **USDC 测试币**: 用于投资和收益分发
- **初始分配**: 每个测试账户 100,000 USDC

### 测试房产数据
```json
{
  "properties": [
    {
      "propertyId": 1001,
      "city": "Amsterdam",
      "type": "Residential",
      "valuation": 1000000,
      "minRaising": 100000,
      "maxRaising": 800000,
      "expectedYield": "6%"
    },
    {
      "propertyId": 1002,
      "city": "Berlin",
      "type": "Commercial",
      "valuation": 2000000,
      "minRaising": 200000,
      "maxRaising": 1600000,
      "expectedYield": "8%"
    }
  ]
}
```

## 测试执行建议

### 测试环境
1. **本地测试**: 使用 Hardhat/Foundry 本地网络
2. **测试网测试**: 部署到 Goerli/Sepolia 测试网
3. **主网分叉测试**: 使用主网分叉进行真实环境测试

### 测试工具
1. **单元测试**: Foundry Test / Hardhat Test
2. **集成测试**: 多合约交互测试
3. **前端测试**: Web3 集成测试
4. **性能测试**: Gas 分析工具

### 测试报告
每个测试用例应包含：
- 测试目的和场景描述
- 前置条件和测试数据
- 执行步骤
- 预期结果和实际结果
- Gas 消耗分析
- 安全性评估

## 风险评估

### 高风险场景
1. **智能合约漏洞**: 可能导致资金损失
2. **Oracle 操纵**: 可能影响房产估值
3. **治理攻击**: 恶意管理员操作
4. **监管风险**: 法规变化影响运营

### 中风险场景
1. **网络拥堵**: 影响用户体验
2. **Gas 费波动**: 增加操作成本
3. **流动性不足**: 影响代币交易

### 低风险场景
1. **UI/UX 问题**: 影响用户体验但不影响资金安全
2. **文档错误**: 可能造成理解偏差

## 结论

本测试案例文档涵盖了 RenToken 项目的各个方面，从基础功能到复杂业务场景，从正常操作到异常处理。通过系统性的测试，可以确保平台的安全性、稳定性和用户体验。

建议按照优先级执行测试：
1. **P0**: 核心功能和安全性测试
2. **P1**: 业务流程和边界条件测试  
3. **P2**: 性能和用户体验测试
4. **P3**: 复杂场景和压力测试

定期更新测试用例，确保与项目发展同步，为 RenToken 平台的成功运营提供坚实保障。