#!/bin/bash

# æ­¤è„šæœ¬å°†åˆçº¦éƒ¨ç½²åˆ°sepolia ä¸Š å¹¶å°†å®ƒä»¬çš„åœ°å€å†™å…¥ sepolia.env æ–‡ä»¶ã€‚
# ä½¿ç”¨ https://eth-sepolia.public.blastapi.io
# ä½¿ç”¨ admin çš„ è´¦æˆ·æ˜¯ æœ¬åœ°keystoreæ–‡ä»¶ï¼Œåœ¨castå‘½ä»¤é‡Œä½¿ç”¨ --account myMetaMaskAcc --password ''
# Mock usdc sepoliaåœ°å€ï¼š 0xDc11EcA4E796D530145CF582531F4fA289F95757
# ä¸éœ€è¦è®¾ç½®USERSï¼Œåªè¦éƒ¨ç½²åˆçº¦å³å¯
# éœ€è¦è®¾ç½® ETHERSCAN_API_KEY ç¯å¢ƒå˜é‡ç”¨äºåˆçº¦éªŒè¯

set -e  # å‡ºé”™æ—¶é€€å‡º

export FOUNDRY_DISABLE_NIGHTLY_WARNING=true

# åˆ›å»º sepolia.env æ–‡ä»¶
ENV_FILE="sepolia.env"
echo "# Generated by init-sepolia.sh - $(date)" > $ENV_FILE
echo "# Sepolia deployment configuration" >> $ENV_FILE
echo "" >> $ENV_FILE

# Sepolia é…ç½®
RPC_URL="https://eth-sepolia.public.blastapi.io"
CHAIN_ID="11155111"
echo "# RPC Configuration" >> $ENV_FILE
echo "RPC_URL=$RPC_URL" >> $ENV_FILE
echo "CHAIN_ID=$CHAIN_ID" >> $ENV_FILE
echo "" >> $ENV_FILE
echo "# Etherscan Configuration" >> $ENV_FILE

echo "Deploying contracts to Sepolia..."

# ä½¿ç”¨ Sepolia ä¸Šçš„ Mock USDC åœ°å€
USDC_ADDR="0xDc11EcA4E796D530145CF582531F4fA289F95757"
echo "Using Mock USDC on Sepolia at $USDC_ADDR"

# æ£€æŸ¥ Etherscan API key
if [ -z "$ETHERSCAN_API_KEY" ]; then
    echo "âŒ Error: ETHERSCAN_API_KEY environment variable is not set"
    echo "Please set ETHERSCAN_API_KEY before running this script"
    exit 1
fi

# éƒ¨ç½² KYCOracle
echo "Deploying KYCOracle..."
KYC_ORACLE_ADDR=$(forge create --broadcast --rpc-url $RPC_URL --account myMetaMaskAcc --password '' --verifier etherscan --etherscan-api-key $ETHERSCAN_API_KEY src/KYCOracle.sol:KYCOracle | grep "Deployed to:" | awk '{print $3}')
echo "Deployed KYCOracle at $KYC_ORACLE_ADDR"
[ -n "$KYC_ORACLE_ADDR" ] || { echo "Error: Failed to deploy KYCOracle"; exit 1; }

# éƒ¨ç½² PropertyOracle
echo "Deploying PropertyOracle..."
PROPERTY_ORACLE_ADDR=$(forge create --broadcast --rpc-url $RPC_URL --account myMetaMaskAcc --password '' --verifier etherscan --etherscan-api-key $ETHERSCAN_API_KEY src/PropertyOracle.sol:PropertyOracle | grep "Deployed to:" | awk '{print $3}')
echo "Deployed PropertyOracle at $PROPERTY_ORACLE_ADDR"
[ -n "$PROPERTY_ORACLE_ADDR" ] || { echo "Error: Failed to deploy PropertyOracle"; exit 1; }

# éƒ¨ç½² RentToken å®ç°
echo "Deploying RentToken implementation..."
RENT_TOKEN_IMPL_ADDR=$(forge create --broadcast --rpc-url $RPC_URL --account myMetaMaskAcc --password '' --verifier etherscan --etherscan-api-key $ETHERSCAN_API_KEY src/RentToken.sol:RentToken | grep "Deployed to:" | awk '{print $3}')
echo "Deployed RentToken implementation at $RENT_TOKEN_IMPL_ADDR"
[ -n "$RENT_TOKEN_IMPL_ADDR" ] || { echo "Error: Failed to deploy RentToken implementation"; exit 1; }

# éƒ¨ç½² MockSanctionOracle
echo "Deploying MockSanctionOracle..."
SANCTION_ORACLE_ADDR=$(forge create --broadcast --rpc-url $RPC_URL --account myMetaMaskAcc --password '' --verifier etherscan --etherscan-api-key $ETHERSCAN_API_KEY src/mocks/MockSanctionOracle.sol:MockSanctionOracle | grep "Deployed to:" | awk '{print $3}')
echo "Deployed MockSanctionOracle at $SANCTION_ORACLE_ADDR"
[ -n "$SANCTION_ORACLE_ADDR" ] || { echo "Error: Failed to deploy MockSanctionOracle"; exit 1; }

# ä½¿ç”¨ PropertyOracle éƒ¨ç½² SeriesFactory
echo "Deploying SeriesFactory..."
SERIES_FACTORY_ADDR=$(forge create --broadcast --rpc-url $RPC_URL --account myMetaMaskAcc --password '' --verifier etherscan --etherscan-api-key $ETHERSCAN_API_KEY src/SeriesFactory.sol:SeriesFactory --constructor-args $PROPERTY_ORACLE_ADDR | grep "Deployed to:" | awk '{print $3}')
echo "Deployed SeriesFactory at $SERIES_FACTORY_ADDR"
[ -n "$SERIES_FACTORY_ADDR" ] || { echo "Error: Failed to deploy SeriesFactory"; exit 1; }

# åœ¨ SeriesFactory ä¸­è®¾ç½® RentToken å®ç°ï¼ˆéƒ¨ç½²è€…å…·æœ‰ç®¡ç†å‘˜è§’è‰²ï¼‰
echo "Setting RentToken implementation in SeriesFactory..."
cast send --rpc-url $RPC_URL --account myMetaMaskAcc --password '' $SERIES_FACTORY_ADDR "updateRentTokenImplementation(address)" $RENT_TOKEN_IMPL_ADDR
echo "Set RentToken implementation in SeriesFactory"

# å†™å…¥åˆçº¦åœ°å€åˆ° sepolia.env æ–‡ä»¶
echo "" >> $ENV_FILE
echo "# Contract Addresses" >> $ENV_FILE
echo "KYC_ORACLE_ADDR=$KYC_ORACLE_ADDR" >> $ENV_FILE
echo "PROPERTY_ORACLE_ADDR=$PROPERTY_ORACLE_ADDR" >> $ENV_FILE
echo "RENT_TOKEN_IMPL_ADDR=$RENT_TOKEN_IMPL_ADDR" >> $ENV_FILE
echo "SANCTION_ORACLE_ADDR=$SANCTION_ORACLE_ADDR" >> $ENV_FILE
echo "SERIES_FACTORY_ADDR=$SERIES_FACTORY_ADDR" >> $ENV_FILE
echo "USDC_ADDR=$USDC_ADDR" >> $ENV_FILE

echo "Deployment complete. Contract addresses written to $ENV_FILE:"
echo "KYC_ORACLE_ADDR=$KYC_ORACLE_ADDR"
echo "PROPERTY_ORACLE_ADDR=$PROPERTY_ORACLE_ADDR"
echo "RENT_TOKEN_IMPL_ADDR=$RENT_TOKEN_IMPL_ADDR"
echo "SANCTION_ORACLE_ADDR=$SANCTION_ORACLE_ADDR"
echo "SERIES_FACTORY_ADDR=$SERIES_FACTORY_ADDR"
echo "USDC_ADDR=$USDC_ADDR"
echo "SANCTION_ORACLE_ADDR=$SANCTION_ORACLE_ADDR"

# éªŒè¯åˆçº¦éƒ¨ç½²
echo "Verifying deployments..."

# éªŒè¯ KYCOracle (è°ƒç”¨ owner())
KYC_OWNER=$(cast call --rpc-url $RPC_URL $KYC_ORACLE_ADDR "owner()(address)")
echo "KYCOracle owner: $KYC_OWNER"

# éªŒè¯ PropertyOracle (è°ƒç”¨ owner())
PROPERTY_OWNER=$(cast call --rpc-url $RPC_URL $PROPERTY_ORACLE_ADDR "owner()(address)")
echo "PropertyOracle owner: $PROPERTY_OWNER"

# éªŒè¯ RentToken implementation (è°ƒç”¨ decimals()ï¼Œå‡è®¾å®ƒæ˜¯å¯è°ƒç”¨çš„)
RENT_DECIMALS=$(cast call --rpc-url $RPC_URL $RENT_TOKEN_IMPL_ADDR "decimals()(uint8)")
echo "RentToken decimals: $RENT_DECIMALS"

# éªŒè¯ SeriesFactory (è°ƒç”¨ propertyOracle())
FACTORY_ORACLE=$(cast call --rpc-url $RPC_URL $SERIES_FACTORY_ADDR "propertyOracle()(address)")
echo "SeriesFactory propertyOracle: $FACTORY_ORACLE"

# éªŒè¯ USDC (è°ƒç”¨ symbol())
USDC_SYMBOL=$(cast call --rpc-url $RPC_URL $USDC_ADDR "symbol()(string)")
echo "USDC symbol: $USDC_SYMBOL"

# éªŒè¯ MockSanctionOracle (è°ƒç”¨ isSanctioned(0x000...000))
SANCTION_CHECK=$(cast call --rpc-url $RPC_URL $SANCTION_ORACLE_ADDR "isSanctioned(address)(bool)" 0x0000000000000000000000000000000000000000)
echo "MockSanctionOracle isSanctioned(0x0): $SANCTION_CHECK"

echo ""
echo "âœ… All environment variables have been written to $ENV_FILE"
echo "ğŸ“ To use these variables in your shell, run: source $ENV_FILE"
echo "ğŸ”§ Or use them in forge scripts with: vmsepolia.envString('VARIABLE_NAME')"
echo ""
echo "ğŸ“‹ Generated sepolia.env file structure:"
echo "   - RPC configuration for Sepolia"
echo "   - Contract addresses"
echo "   - Mock USDC address on Sepolia"
echo ""
echo "âš ï¸  Note: sepolia.env file is gitignored for security. Keep your private keys safe!"
echo "ğŸ’¡ You can copy sepolia.env.example to sepolia.env and run this script to populate it."


# æ·»åŠ åœ°å€åˆ°KYCç™½åå•
cast send $KYC_ORACLE_ADDR "addToWhitelist(address)" "0xE991bC71A371055B3f02aa79b79E4b714A3D04c0" --rpc-url $RPC_URL --account myMetaMaskAcc --password ''
cast send $KYC_ORACLE_ADDR "addToWhitelist(address)" "0x4DaA04d0B4316eCC9191Ae07102eC08Bded637a2" --rpc-url $RPC_URL --account myMetaMaskAcc --password ''
cast send $KYC_ORACLE_ADDR "addToWhitelist(address)" "0xf0E1C276407DD69D2a776bb82894160Cf3B25eB3" --rpc-url $RPC_URL --account myMetaMaskAcc --password ''
cast send $KYC_ORACLE_ADDR "addToWhitelist(address)" "0x3F67ECcD86D802355046909Ffc68308dA0969EC7" --rpc-url $RPC_URL --account myMetaMaskAcc --password ''
cast send $KYC_ORACLE_ADDR "addToWhitelist(address)" "0xCe8dDFb00773162A020b95Ffb4Cf067b3A61b99c" --rpc-url $RPC_URL --account myMetaMaskAcc --password ''
cast send $KYC_ORACLE_ADDR "addToWhitelist(address)" "0x64078503e9d53b0d9e6CE2B04DBCe8BCF8dc5ee2" --rpc-url $RPC_URL --account myMetaMaskAcc --password ''
cast send $KYC_ORACLE_ADDR "addToWhitelist(address)" "0x302919D2A33C48e2bC82dE4077A5427a3Ef7E685" --rpc-url $RPC_URL --account myMetaMaskAcc --password ''
cast send $KYC_ORACLE_ADDR "addToWhitelist(address)" "0xcC44277d1d6eC279Cd81e23111B1701758A3f82F" --rpc-url $RPC_URL --account myMetaMaskAcc --password ''
