#!/bin/bash

# æ­¤è„šæœ¬å°†åˆçº¦éƒ¨ç½²åˆ°æœ¬åœ° Anvil å®ä¾‹å¹¶å°†å®ƒä»¬çš„åœ°å€å†™å…¥ .env æ–‡ä»¶ã€‚
# å‡è®¾ Anvil åœ¨ localhost:8545 ä¸Šè¿è¡Œã€‚ä½¿ç”¨ ./init-local.sh è¿è¡Œä»¥ç”Ÿæˆ .env æ–‡ä»¶ã€‚

set -e  # å‡ºé”™æ—¶é€€å‡º

export FOUNDRY_DISABLE_NIGHTLY_WARNING=true

# ç”Ÿæˆ5ä¸ªæµ‹è¯•è´¦æˆ·
echo "Generating 5 test accounts from Anvil default mnemonic..."
MNEMONIC="test test test test test test test test test test test junk"

# åˆ›å»º .env æ–‡ä»¶
ENV_FILE=".env"
echo "# Generated by init-local.sh - $(date)" > $ENV_FILE
echo "# Local Anvil deployment configuration" >> $ENV_FILE
echo "" >> $ENV_FILE

# è®¾ç½®å¸¸ç”¨åˆ«å
ADMIN_ADDRESS=$(cast wallet address --mnemonic "$MNEMONIC" --mnemonic-index 0 2>/dev/null)
ADMIN_PRIVATE_KEY=$(cast wallet derive-private-key --mnemonic "$MNEMONIC" --mnemonic-index 0 2>/dev/null)
USER1_ADDRESS=$(cast wallet address --mnemonic "$MNEMONIC" --mnemonic-index 1 2>/dev/null)
USER1_PRIVATE_KEY=$(cast wallet derive-private-key --mnemonic "$MNEMONIC" --mnemonic-index 1 2>/dev/null)
USER2_ADDRESS=$(cast wallet address --mnemonic "$MNEMONIC" --mnemonic-index 2 2>/dev/null)
USER2_PRIVATE_KEY=$(cast wallet derive-private-key --mnemonic "$MNEMONIC" --mnemonic-index 2 2>/dev/null)
USER3_ADDRESS=$(cast wallet address --mnemonic "$MNEMONIC" --mnemonic-index 3 2>/dev/null)
USER3_PRIVATE_KEY=$(cast wallet derive-private-key --mnemonic "$MNEMONIC" --mnemonic-index 3 2>/dev/null)
USER4_ADDRESS=$(cast wallet address --mnemonic "$MNEMONIC" --mnemonic-index 4 2>/dev/null)
USER4_PRIVATE_KEY=$(cast wallet derive-private-key --mnemonic "$MNEMONIC" --mnemonic-index 4 2>/dev/null)

echo "# Test account addresses and private keys" >> $ENV_FILE
echo "ADMIN_ADDRESS=$ADMIN_ADDRESS" >> $ENV_FILE
echo "ADMIN_PRIVATE_KEY=$ADMIN_PRIVATE_KEY" >> $ENV_FILE
echo "USER1_ADDRESS=$USER1_ADDRESS" >> $ENV_FILE
echo "USER1_PRIVATE_KEY=$USER1_PRIVATE_KEY" >> $ENV_FILE
echo "USER2_ADDRESS=$USER2_ADDRESS" >> $ENV_FILE
echo "USER2_PRIVATE_KEY=$USER2_PRIVATE_KEY" >> $ENV_FILE
echo "USER3_ADDRESS=$USER3_ADDRESS" >> $ENV_FILE
echo "USER3_PRIVATE_KEY=$USER3_PRIVATE_KEY" >> $ENV_FILE
echo "USER4_ADDRESS=$USER4_ADDRESS" >> $ENV_FILE
echo "USER4_PRIVATE_KEY=$USER4_PRIVATE_KEY" >> $ENV_FILE

echo "Test accounts generated:"
echo "ADMIN: $ADMIN_ADDRESS"
echo "USER1: $USER1_ADDRESS"
echo "USER2: $USER2_ADDRESS"
echo "USER3: $USER3_ADDRESS"
echo "USER4: $USER4_ADDRESS"

RPC_URL="http://localhost:8545"
echo "" >> $ENV_FILE
echo "# RPC Configuration" >> $ENV_FILE
echo "RPC_URL=$RPC_URL" >> $ENV_FILE

echo "Deploying contracts to local Anvil..."

# æ³¨æ„: æ­¤è„šæœ¬å‡è®¾ Anvil ä»¥ä¸»ç½‘ fork æ¨¡å¼è¿è¡Œ (anvil --fork-url <mainnet_rpc>)ï¼Œä»¥ä½¿ç”¨çœŸå®çš„ USDC å’Œ Sanction Oracle åˆçº¦ã€‚

# éƒ¨ç½² KYCOracle
KYC_ORACLE_ADDR=$(forge create --broadcast --rpc-url $RPC_URL --private-key $ADMIN_PRIVATE_KEY src/KYCOracle.sol:KYCOracle | grep "Deployed to:" | awk '{print $3}')
echo "Deployed KYCOracle at $KYC_ORACLE_ADDR"
[ -n "$KYC_ORACLE_ADDR" ] || { echo "Error: Failed to deploy KYCOracle"; exit 1; }

# éƒ¨ç½² PropertyOracle
PROPERTY_ORACLE_ADDR=$(forge create --broadcast --rpc-url $RPC_URL --private-key $ADMIN_PRIVATE_KEY src/PropertyOracle.sol:PropertyOracle | grep "Deployed to:" | awk '{print $3}')
echo "Deployed PropertyOracle at $PROPERTY_ORACLE_ADDR"
[ -n "$PROPERTY_ORACLE_ADDR" ] || { echo "Error: Failed to deploy PropertyOracle"; exit 1; }

# éƒ¨ç½² RentToken å®ç°
RENT_TOKEN_IMPL_ADDR=$(forge create --broadcast --rpc-url $RPC_URL --private-key $ADMIN_PRIVATE_KEY src/RentToken.sol:RentToken | grep "Deployed to:" | awk '{print $3}')
echo "Deployed RentToken implementation at $RENT_TOKEN_IMPL_ADDR"
[ -n "$RENT_TOKEN_IMPL_ADDR" ] || { echo "Error: Failed to deploy RentToken implementation"; exit 1; }

# ä½¿ç”¨çœŸå®çš„ä¸»ç½‘åœ°å€
USDC_ADDR=0xA0b86991c6218b36c1d19d4a2e9eb0ce3606eb48
echo "Using real USDC at $USDC_ADDR"
SANCTION_ORACLE_ADDR=0x40C57923924B5c5c5455c48D93317139ADDaC8fb
echo "Using real Sanction Oracle at $SANCTION_ORACLE_ADDR"

# ä½¿ç”¨ PropertyOracle éƒ¨ç½² SeriesFactory
SERIES_FACTORY_ADDR=$(forge create --broadcast --rpc-url $RPC_URL --private-key $ADMIN_PRIVATE_KEY src/SeriesFactory.sol:SeriesFactory --constructor-args $PROPERTY_ORACLE_ADDR | grep "Deployed to:" | awk '{print $3}')
echo "Deployed SeriesFactory at $SERIES_FACTORY_ADDR"
[ -n "$SERIES_FACTORY_ADDR" ] || { echo "Error: Failed to deploy SeriesFactory"; exit 1; }

# åœ¨ SeriesFactory ä¸­è®¾ç½® RentToken å®ç°ï¼ˆéƒ¨ç½²è€…å…·æœ‰ç®¡ç†å‘˜è§’è‰²ï¼‰
cast send --rpc-url $RPC_URL --private-key $ADMIN_PRIVATE_KEY $SERIES_FACTORY_ADDR "updateRentTokenImplementation(address)" $RENT_TOKEN_IMPL_ADDR
echo "Set RentToken implementation in SeriesFactory"

# å†™å…¥åˆçº¦åœ°å€åˆ° .env æ–‡ä»¶
echo "" >> $ENV_FILE
echo "# Contract Addresses" >> $ENV_FILE
echo "KYC_ORACLE_ADDR=$KYC_ORACLE_ADDR" >> $ENV_FILE
echo "PROPERTY_ORACLE_ADDR=$PROPERTY_ORACLE_ADDR" >> $ENV_FILE
echo "RENT_TOKEN_IMPL_ADDR=$RENT_TOKEN_IMPL_ADDR" >> $ENV_FILE
echo "SERIES_FACTORY_ADDR=$SERIES_FACTORY_ADDR" >> $ENV_FILE
echo "USDC_ADDR=$USDC_ADDR" >> $ENV_FILE
echo "SANCTION_ORACLE_ADDR=$SANCTION_ORACLE_ADDR" >> $ENV_FILE

echo "Deployment complete. Contract addresses written to $ENV_FILE:"
echo "KYC_ORACLE_ADDR=$KYC_ORACLE_ADDR"
echo "PROPERTY_ORACLE_ADDR=$PROPERTY_ORACLE_ADDR"
echo "RENT_TOKEN_IMPL_ADDR=$RENT_TOKEN_IMPL_ADDR"
echo "SERIES_FACTORY_ADDR=$SERIES_FACTORY_ADDR"
echo "USDC_ADDR=$USDC_ADDR"
echo "SANCTION_ORACLE_ADDR=$SANCTION_ORACLE_ADDR"

# éªŒè¯åˆçº¦éƒ¨ç½²
echo "Verifying deployments..."

# éªŒè¯ KYCOracle (è°ƒç”¨ owner())
KYC_OWNER=$(cast call --rpc-url $RPC_URL $KYC_ORACLE_ADDR "owner()(address)")
echo "KYCOracle owner: $KYC_OWNER"

# éªŒè¯ PropertyOracle (è°ƒç”¨ owner())
PROPERTY_OWNER=$(cast call --rpc-url $RPC_URL $PROPERTY_ORACLE_ADDR "owner()(address)")
echo "PropertyOracle owner: $PROPERTY_OWNER"

# éªŒè¯ RentToken implementation (è°ƒç”¨ decimals()ï¼Œå‡è®¾å®ƒæ˜¯å¯è°ƒç”¨çš„)
RENT_DECIMALS=$(cast call --rpc-url $RPC_URL $RENT_TOKEN_IMPL_ADDR "decimals()(uint8)")
echo "RentToken decimals: $RENT_DECIMALS"

# éªŒè¯ SeriesFactory (è°ƒç”¨ propertyOracle())
FACTORY_ORACLE=$(cast call --rpc-url $RPC_URL $SERIES_FACTORY_ADDR "propertyOracle()(address)")
echo "SeriesFactory propertyOracle: $FACTORY_ORACLE"

# éªŒè¯ USDC (è°ƒç”¨ symbol())
USDC_SYMBOL=$(cast call --rpc-url $RPC_URL $USDC_ADDR "symbol()(string)")
echo "USDC symbol: $USDC_SYMBOL"

# éªŒè¯ SanctionOracle (è°ƒç”¨ isSanctioned(0x000...000))
SANCTION_CHECK=$(cast call --rpc-url $RPC_URL $SANCTION_ORACLE_ADDR "isSanctioned(address)(bool)" 0x0000000000000000000000000000000000000000)
echo "SanctionOracle isSanctioned(0x0): $SANCTION_CHECK"

# ç”¨usdcå·¨é²¸è´¦æˆ·ç»™userå……å€¼ï¼Œæ¯äºº1e4 usdc
echo "ğŸ’° Funding test accounts with USDC from whale..."

# ä½¿ç”¨å·²çŸ¥çš„ USDC å·¨é²¸è´¦æˆ·
USDC_WHALE=0x55fe002aeff02f77364de339a1292923a15844b8

# æ¨¡æ‹Ÿå·¨é²¸è´¦æˆ·
cast rpc --rpc-url $RPC_URL anvil_impersonateAccount $USDC_WHALE

# ç»™æ¯ä¸ªæµ‹è¯•è´¦æˆ·å……å€¼ 10000 USDC (1e4 * 1e6 = 1e10)
echo "ğŸ’¸ Transferring 10000 USDC to each test account..."

# ç»™ ADMIN å……å€¼
cast send --rpc-url $RPC_URL --from $USDC_WHALE --unlocked $USDC_ADDR "transfer(address,uint256)" $ADMIN_ADDRESS 10000000000 || { echo "âŒ Failed to fund ADMIN"; exit 1; }
echo "âœ… ADMIN funded with 10000 USDC"

# ç»™ USER1 å……å€¼
cast send --rpc-url $RPC_URL --from $USDC_WHALE --unlocked $USDC_ADDR "transfer(address,uint256)" $USER1_ADDRESS 10000000000 || { echo "âŒ Failed to fund USER1"; exit 1; }
echo "âœ… USER1 funded with 10000 USDC"

# ç»™ USER2 å……å€¼
cast send --rpc-url $RPC_URL --from $USDC_WHALE --unlocked $USDC_ADDR "transfer(address,uint256)" $USER2_ADDRESS 10000000000 || { echo "âŒ Failed to fund USER2"; exit 1; }
echo "âœ… USER2 funded with 10000 USDC"

# ç»™ USER3 å……å€¼
cast send --rpc-url $RPC_URL --from $USDC_WHALE --unlocked $USDC_ADDR "transfer(address,uint256)" $USER3_ADDRESS 10000000000 || { echo "âŒ Failed to fund USER3"; exit 1; }
echo "âœ… USER3 funded with 10000 USDC"

# ç»™ USER4 å……å€¼
cast send --rpc-url $RPC_URL --from $USDC_WHALE --unlocked $USDC_ADDR "transfer(address,uint256)" $USER4_ADDRESS 10000000000 || { echo "âŒ Failed to fund USER4"; exit 1; }
echo "âœ… USER4 funded with 10000 USDC"

# åœæ­¢æ¨¡æ‹Ÿå·¨é²¸è´¦æˆ·
cast rpc --rpc-url $RPC_URL anvil_stopImpersonatingAccount $USDC_WHALE

# éªŒè¯å……å€¼ç»“æœ
echo "ğŸ” Verifying USDC balances..."

ADMIN_USDC_BALANCE=$(cast call --rpc-url $RPC_URL $USDC_ADDR "balanceOf(address)(uint256)" $ADMIN_ADDRESS)
USER1_USDC_BALANCE=$(cast call --rpc-url $RPC_URL $USDC_ADDR "balanceOf(address)(uint256)" $USER1_ADDRESS)
USER2_USDC_BALANCE=$(cast call --rpc-url $RPC_URL $USDC_ADDR "balanceOf(address)(uint256)" $USER2_ADDRESS)
USER3_USDC_BALANCE=$(cast call --rpc-url $RPC_URL $USDC_ADDR "balanceOf(address)(uint256)" $USER3_ADDRESS)
USER4_USDC_BALANCE=$(cast call --rpc-url $RPC_URL $USDC_ADDR "balanceOf(address)(uint256)" $USER4_ADDRESS)

echo "USDC Balances:"
echo "  ADMIN:  $ADMIN_USDC_BALANCE (should be >= 10000000000)"
echo "  USER1:  $USER1_USDC_BALANCE (should be >= 10000000000)"
echo "  USER2:  $USER2_USDC_BALANCE (should be >= 10000000000)"
echo "  USER3:  $USER3_USDC_BALANCE (should be >= 10000000000)"
echo "  USER4:  $USER4_USDC_BALANCE (should be >= 10000000000)"

echo "" >> $ENV_FILE
echo "# USDC Whale for funding" >> $ENV_FILE
echo "USDC_WHALE=$USDC_WHALE" >> $ENV_FILE

echo ""
echo "âœ… All environment variables have been written to $ENV_FILE"
echo "ğŸ“ To use these variables in your shell, run: source $ENV_FILE"
echo "ğŸ”§ Or use them in forge scripts with: vm.envString('VARIABLE_NAME')"
echo ""
echo "ğŸ“‹ Generated .env file structure:"
echo "   - Test account addresses and private keys (ADMIN, USER1, etc.)"
echo "   - RPC configuration"
echo "   - Contract addresses"
echo "   - USDC whale address for funding"
echo ""
echo "âš ï¸  Note: .env file is gitignored for security. Keep your private keys safe!"
echo "ğŸ’¡ You can copy .env.example to .env and run this script to populate it."

# === CLI é›†æˆåˆå§‹åŒ– ===
echo ""
echo "ğŸ”§ CLI Integration Setup..."
echo "=================================================="

# åˆ›å»ºå¹¶æ›´æ–° addresses JSON æ–‡ä»¶
ADDRESSES_FILE="addresses/${NETWORK:-mainnet-fork}.json"
mkdir -p "addresses"

# ä½¿ç”¨ jq æ›´æ–°åœ°å€æ–‡ä»¶
cat > "$ADDRESSES_FILE" << EOF
{
  "KYCOracle": "$KYC_ORACLE_ADDR",
  "PropertyOracle": "$PROPERTY_ORACLE_ADDR",
  "SeriesFactory": "$SERIES_FACTORY_ADDR",
  "RentTokenImpl": "$RENT_TOKEN_IMPL_ADDR",
  "SanctionOracle": "$SANCTION_ORACLE_ADDR"
}
EOF

echo "âœ… Address file updated: $ADDRESSES_FILE"

# éªŒè¯ CLI å·¥å…·
if [[ -f "bin/rwa" ]]; then
    echo "ğŸ” Verifying CLI tool..."
    
    # æµ‹è¯•åŸºæœ¬å‘½ä»¤
    echo "   Testing addr:show command..."
    ./bin/rwa addr:show ADMIN >/dev/null 2>&1 && echo "   âœ… addr:show working" || echo "   âŒ addr:show failed"
    
    echo "   Testing block:chainid command..."
    ./bin/rwa block:chainid >/dev/null 2>&1 && echo "   âœ… block:chainid working" || echo "   âŒ block:chainid failed"
    
    echo "âœ… CLI tool verified"
else
    echo "âš ï¸  CLI tool not found at bin/rwa"
fi

# æ·»åŠ ç½‘ç»œé…ç½®åˆ° .envï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
if ! grep -q "NETWORK=" "$ENV_FILE"; then
    echo "" >> "$ENV_FILE"
    echo "# CLI Configuration" >> "$ENV_FILE"
    echo "NETWORK=mainnet-fork" >> "$ENV_FILE"
fi

echo ""
echo "ğŸ¯ CLI Quick Start:"
echo "   Check ADMIN address:     ./bin/rwa addr:show ADMIN"
echo "   Check KYC status:        ./bin/rwa kyc:check \$USER1_ADDRESS"
echo "   Add user to KYC:         ./bin/rwa kyc:add USER1 --yes"
echo "   Check USDC balance:      ./bin/rwa erc20:balance \$USDC_ADDR USER1"
echo ""
echo "ğŸ“š Full command list:      ./bin/rwa help"
echo "ğŸ“– Documentation:          docs/CLI.md"
